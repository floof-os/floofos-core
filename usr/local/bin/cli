#!/bin/bash

# FloofOS - Fast Line-rate Offload On Fabric Operating System
# Copyright (C) 2025 FloofOS Networks <dev@floofos.io>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License.

MAX_WAIT=30
WAITED=0

while [ ! -f /var/run/netns/dataplane ] && [ $WAITED -lt $MAX_WAIT ]; do
    sleep 1
    WAITED=$((WAITED + 1))
done

if [ ! -f /var/run/netns/dataplane ]; then
    echo "Error: dataplane namespace not ready after ${MAX_WAIT}s"
    echo "Check: systemctl status netns-dataplane"
    exit 1
fi

if [ -n "$FLOOFCTL_SHELL" ]; then
    CLI_SESSION=1
else
    CLI_SESSION=0
fi

ORIGINAL_USER="${SUDO_USER:-$USER}"

ENV_ARGS=()
ENV_ARGS+=("FLOOFOS_CLI_SESSION=$CLI_SESSION")
ENV_ARGS+=("FLOOFOS_LOGIN_USER=$ORIGINAL_USER")
[ -n "$SSH_CLIENT" ] && ENV_ARGS+=("SSH_CLIENT=$SSH_CLIENT")
[ -n "$SSH_CONNECTION" ] && ENV_ARGS+=("SSH_CONNECTION=$SSH_CONNECTION")

if [ "$(id -u)" -eq 0 ]; then
    /sbin/ip netns exec dataplane env "${ENV_ARGS[@]}" /usr/bin/floof-cli "$@"
else
    sudo /sbin/ip netns exec dataplane env "${ENV_ARGS[@]}" /usr/bin/floof-cli "$@"
fi
