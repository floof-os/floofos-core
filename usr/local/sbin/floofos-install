#!/bin/bash

# FloofOS - Fast Line-rate Offload On Fabric Operating System
# Copyright (C) 2025 FloofOS Networks <dev@floofos.io>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License.

set -e

DISK=""
HOSTNAME="floofos"
CONSOLE="kvm"
PASSWORD=""
PRESERVE_CONFIG="false"
CONFIG_COMMIT="-1"

while [[ $# -gt 0 ]]; do
    case $1 in
        --disk)
            DISK="$2"
            shift 2
            ;;
        --hostname)
            HOSTNAME="$2"
            shift 2
            ;;
        --console)
            CONSOLE="$2"
            shift 2
            ;;
        --password)
            PASSWORD="$2"
            shift 2
            ;;
        --preserve-config)
            PRESERVE_CONFIG="$2"
            shift 2
            ;;
        --config-commit)
            CONFIG_COMMIT="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

if [ -z "$DISK" ]; then
    echo "Error: No target disk specified"
    exit 1
fi

if [ -z "$PASSWORD" ]; then
    echo "Error: No password specified"
    exit 1
fi

if [ ! -b "$DISK" ]; then
    echo "Error: $DISK is not a valid block device"
    exit 1
fi

if [ "$(id -u)" -ne 0 ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

echo "[1/9] Unmounting existing partitions..."
umount ${DISK}* 2>/dev/null || true
swapoff ${DISK}* 2>/dev/null || true

IS_UEFI="false"
if [ -d /sys/firmware/efi ]; then
    IS_UEFI="true"
fi

echo "[2/9] Creating partition table..."
parted -s "$DISK" mklabel gpt

if [ "$IS_UEFI" = "true" ]; then
    parted -s "$DISK" mkpart primary fat32 1MiB 513MiB
    parted -s "$DISK" set 1 esp on
    parted -s "$DISK" mkpart primary ext4 513MiB 100%
else
    parted -s "$DISK" mkpart grub 1MiB 3MiB
    parted -s "$DISK" set 1 bios_grub on
    parted -s "$DISK" mkpart primary ext4 3MiB 100%
fi

sleep 2

if [[ "$DISK" == *"nvme"* ]]; then
    if [ "$IS_UEFI" = "true" ]; then
        EFI_PART="${DISK}p1"
        ROOT_PART="${DISK}p2"
    else
        ROOT_PART="${DISK}p2"
    fi
else
    if [ "$IS_UEFI" = "true" ]; then
        EFI_PART="${DISK}1"
        ROOT_PART="${DISK}2"
    else
        ROOT_PART="${DISK}2"
    fi
fi

echo "[3/9] Formatting partitions..."
if [ "$IS_UEFI" = "true" ]; then
    mkfs.fat -F32 "$EFI_PART"
fi
mkfs.ext4 -F -L floofos-root "$ROOT_PART"

echo "[4/9] Mounting target filesystem..."
MOUNT_DIR="/mnt/floofos-install"
mkdir -p "$MOUNT_DIR"
mount "$ROOT_PART" "$MOUNT_DIR"
if [ "$IS_UEFI" = "true" ]; then
    mkdir -p "$MOUNT_DIR/boot/efi"
    mount "$EFI_PART" "$MOUNT_DIR/boot/efi"
fi

echo "[5/9] Copying system files..."
rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found","/swapfile"} / "$MOUNT_DIR/" 2>/dev/null

echo "[6/9] Configuring system..."

echo "$HOSTNAME" > "$MOUNT_DIR/etc/hostname"
cat > "$MOUNT_DIR/etc/hosts" <<EOF
127.0.0.1   localhost
127.0.1.1   $HOSTNAME

::1         localhost ip6-localhost ip6-loopback
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
EOF

echo "floofos:$PASSWORD" | chroot "$MOUNT_DIR" chpasswd
echo "root:$PASSWORD" | chroot "$MOUNT_DIR" chpasswd

ROOT_UUID=$(blkid -s UUID -o value "$ROOT_PART")

if [ "$IS_UEFI" = "true" ]; then
    EFI_UUID=$(blkid -s UUID -o value "$EFI_PART")
    cat > "$MOUNT_DIR/etc/fstab" <<EOF
UUID=$ROOT_UUID   /           ext4    errors=remount-ro   0   1
UUID=$EFI_UUID    /boot/efi   vfat    umask=0077          0   1
EOF
else
    cat > "$MOUNT_DIR/etc/fstab" <<EOF
UUID=$ROOT_UUID   /           ext4    errors=remount-ro   0   1
EOF
fi

if [ "$CONSOLE" = "serial" ]; then
    mkdir -p "$MOUNT_DIR/etc/default"
    sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="console=ttyS0,115200n8"/' "$MOUNT_DIR/etc/default/grub" 2>/dev/null || true
    sed -i 's/^GRUB_TERMINAL=.*/GRUB_TERMINAL="serial console"/' "$MOUNT_DIR/etc/default/grub" 2>/dev/null || true
fi

chroot "$MOUNT_DIR" apt-get remove --purge -y live-boot live-boot-initramfs-tools live-config live-config-systemd 2>/dev/null || true
chroot "$MOUNT_DIR" apt-get autoremove -y 2>/dev/null || true

rm -f "$MOUNT_DIR/etc/live" 2>/dev/null || true
rm -rf "$MOUNT_DIR/lib/live" 2>/dev/null || true

if [ "$PRESERVE_CONFIG" = "true" ]; then
    echo "[7/9] Preserving configuration..."
    
    mkdir -p "$MOUNT_DIR/etc/floofos-config/commits"
    mkdir -p "$MOUNT_DIR/etc/floofos-config/backups"
    mkdir -p "$MOUNT_DIR/etc/vpp/config"
    mkdir -p "$MOUNT_DIR/etc/nftables.d"
    
    if [ -d /etc/floofos-config ]; then
        cp -a /etc/floofos-config/. "$MOUNT_DIR/etc/floofos-config/"
    fi
    
    if [ "$CONFIG_COMMIT" != "-1" ] && [ -d "/etc/floofos-config/commits/$CONFIG_COMMIT" ]; then
        COMMIT_DIR="/etc/floofos-config/commits/$CONFIG_COMMIT"
        
        [ -f "$COMMIT_DIR/pathvector.yml" ] && cp "$COMMIT_DIR/pathvector.yml" "$MOUNT_DIR/etc/pathvector.yml"
        [ -f "$COMMIT_DIR/head.vpp" ] && cp "$COMMIT_DIR/head.vpp" "$MOUNT_DIR/etc/vpp/config/head.vpp"
        [ -f "$COMMIT_DIR/vppcfg.vpp" ] && cp "$COMMIT_DIR/vppcfg.vpp" "$MOUNT_DIR/etc/vpp/config/vppcfg.vpp"
        [ -f "$COMMIT_DIR/tail.vpp" ] && cp "$COMMIT_DIR/tail.vpp" "$MOUNT_DIR/etc/vpp/config/tail.vpp"
        [ -f "$COMMIT_DIR/dataplane.yaml" ] && cp "$COMMIT_DIR/dataplane.yaml" "$MOUNT_DIR/etc/vpp/dataplane.yaml"
    else
        [ -f /etc/pathvector.yml ] && cp /etc/pathvector.yml "$MOUNT_DIR/etc/pathvector.yml"
        [ -f /etc/vpp/config/head.vpp ] && cp /etc/vpp/config/head.vpp "$MOUNT_DIR/etc/vpp/config/head.vpp"
        [ -f /etc/vpp/config/vppcfg.vpp ] && cp /etc/vpp/config/vppcfg.vpp "$MOUNT_DIR/etc/vpp/config/vppcfg.vpp"
        [ -f /etc/vpp/config/tail.vpp ] && cp /etc/vpp/config/tail.vpp "$MOUNT_DIR/etc/vpp/config/tail.vpp"
        [ -f /etc/vpp/dataplane.yaml ] && cp /etc/vpp/dataplane.yaml "$MOUNT_DIR/etc/vpp/dataplane.yaml"
    fi
    
    [ -d /etc/nftables.d ] && cp -a /etc/nftables.d/. "$MOUNT_DIR/etc/nftables.d/"
    [ -f /etc/floofctl/users.json ] && cp /etc/floofctl/users.json "$MOUNT_DIR/etc/floofctl/users.json"
    
    cat > "$MOUNT_DIR/etc/systemd/system/floofos-config-restore.service" <<'EOFSERVICE'
[Unit]
Description=FloofOS Configuration Restore
After=vpp.service bird-dataplane.service
Wants=vpp.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/floofos-config-restore.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOFSERVICE

    cat > "$MOUNT_DIR/usr/local/bin/floofos-config-restore.sh" <<'EOFRESTORE'
#!/bin/bash
LOG="/var/log/floofos-config-restore.log"
exec > >(tee -a "$LOG") 2>&1

sleep 5

if [ -f /etc/vpp/config/vppcfg.vpp ]; then
    vppctl exec /etc/vpp/config/vppcfg.vpp 2>/dev/null || true
fi

if [ -f /etc/pathvector.yml ]; then
    pathvector generate 2>/dev/null || true
    sleep 2
    ip netns exec dataplane birdc configure 2>/dev/null || true
fi

systemctl disable floofos-config-restore.service 2>/dev/null || true
rm -f /etc/systemd/system/floofos-config-restore.service 2>/dev/null || true
systemctl daemon-reload 2>/dev/null || true

exit 0
EOFRESTORE

    chmod +x "$MOUNT_DIR/usr/local/bin/floofos-config-restore.sh"
    chroot "$MOUNT_DIR" systemctl enable floofos-config-restore.service 2>/dev/null || true
else
    echo "[7/9] Skipping configuration preservation..."
fi

echo "[8/9] Installing bootloader..."

mount --bind /dev "$MOUNT_DIR/dev"
mount --bind /dev/pts "$MOUNT_DIR/dev/pts"
mount --bind /proc "$MOUNT_DIR/proc"
mount --bind /sys "$MOUNT_DIR/sys"

if [ "$IS_UEFI" = "true" ]; then
    mount --bind /sys/firmware/efi/efivars "$MOUNT_DIR/sys/firmware/efi/efivars" 2>/dev/null || true
    chroot "$MOUNT_DIR" grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=FloofOS --recheck
else
    chroot "$MOUNT_DIR" grub-install --target=i386-pc "$DISK"
fi

chroot "$MOUNT_DIR" update-grub

chroot "$MOUNT_DIR" update-initramfs -u -k all

echo "[9/9] Cleaning up..."

if [ "$IS_UEFI" = "true" ]; then
    umount "$MOUNT_DIR/sys/firmware/efi/efivars" 2>/dev/null || true
fi
umount "$MOUNT_DIR/sys" 2>/dev/null || true
umount "$MOUNT_DIR/proc" 2>/dev/null || true
umount "$MOUNT_DIR/dev/pts" 2>/dev/null || true
umount "$MOUNT_DIR/dev" 2>/dev/null || true

sync

if [ "$IS_UEFI" = "true" ]; then
    umount "$MOUNT_DIR/boot/efi" 2>/dev/null || true
fi
umount "$MOUNT_DIR"

echo ""
echo "Installation completed successfully!"
echo ""
echo "Installation complete."
echo ""
echo "Remove the installation media and reboot the system."
echo "To reboot now, type: reboot"
